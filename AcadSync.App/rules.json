{
    "$id": "https://yourco.dev/schemas/eprl.v1.json",
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "type": "object",
    "required": [ "apiVersion", "tenant", "ruleset", "rules" ],
    "properties": {
        "apiVersion": { "const": "eprl.v1" },
        "tenant": {
            "type": "string",
            "minLength": 1
        },
        "ruleset": {
            "type": "object",
            "required": [ "id", "name", "version" ],
            "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" },
                "version": {
                    "type": "integer",
                    "minimum": 1
                },
                "effectiveFrom": {
                    "type": "string",
                    "format": "date"
                },
                "owner": { "type": "string" }
            }
        },
        "defaults": {
            "type": "object",
            "properties": {
                "mode": { "enum": [ "validate", "repair", "simulate" ] },
                "severity": { "enum": [ "info", "warning", "error", "block" ] },
                "timezone": { "type": "string" }
            }
        },
        "rules": {
            "type": "array",
            "items": { "$ref": "#/$defs/rule" },
            "minItems": 1
        }
    },
    "$defs": {
        "rule": {
            "type": "object",
            "required": [ "id", "name", "scope", "requirements" ],
            "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" },
                "mode": { "enum": [ "validate", "repair", "simulate" ] },
                "scope": {
                    "type": "object",
                    "required": [ "entity" ],
                    "properties": {
                        "entity": { "enum": [ "Student", "Course", "Section", "Group", "Document", "Enrollment", "Account", "Program" ] }
                    }
                },
                "when": { "$ref": "#/$defs/condition" },
                "requirements": {
                    "type": "array",
                    "minItems": 1,
                    "items": { "$ref": "#/$defs/requirement" }
                },
                "onGroupFailure": { "$ref": "#/$defs/actionsBlock" }
            }
        },
        "condition": {
            "type": "object",
            "properties": {
                "all": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/condition" }
                },
                "any": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/condition" }
                },
                "none": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/condition" }
                },
                "eq": { "$ref": "#/$defs/compare" },
                "ne": { "$ref": "#/$defs/compare" },
                "in": { "$ref": "#/$defs/multiCompare" },
                "notIn": { "$ref": "#/$defs/multiCompare" },
                "regex": { "$ref": "#/$defs/compare" },
                "gt": { "$ref": "#/$defs/compare" },
                "gte": { "$ref": "#/$defs/compare" },
                "lt": { "$ref": "#/$defs/compare" },
                "lte": { "$ref": "#/$defs/compare" },
                "exists": {
                    "type": "object",
                    "required": [ "path" ],
                    "properties": { "path": { "type": "string" } }
                },
                "notExists": {
                    "type": "object",
                    "required": [ "path" ],
                    "properties": { "path": { "type": "string" } }
                }
            },
            "minProperties": 1,
            "additionalProperties": false
        },
        "compare": {
            "type": "object",
            "required": [ "path" ],
            "properties": {
                "path": { "type": "string" },
                "value": {}
            }
        },
        "multiCompare": {
            "type": "object",
            "required": [ "path", "values" ],
            "properties": {
                "path": { "type": "string" },
                "values": { "type": "array" }
            }
        },
        "requirement": {
            "type": "object",
            "required": [ "property", "type", "required" ],
            "properties": {
                "property": { "type": "string" },
                "type": { "enum": [ "string", "int", "decimal", "date", "bool", "lookup" ] },
                "required": { "type": "boolean" },
                "constraints": {
                    "type": "object",
                    "additionalProperties": true
                },
                "lookup": {
                    "type": "object",
                    "properties": {
                        "list": {
                            "type": "array",
                            "items": { "type": "string" }
                        }
                    }
                },
                "normalize": {
                    "type": "object",
                    "additionalProperties": true
                },
                "source": { "$ref": "#/$defs/source" },
                "onFailure": { "$ref": "#/$defs/actionsBlock" }
            }
        },
        "source": {
            "type": "object",
            "properties": {
                "try": {
                    "type": "array",
                    "items": {
                        "oneOf": [
                            {
                                "type": "object",
                                "required": [ "path" ],
                                "properties": { "path": { "type": "string" } }
                            },
                            {
                                "type": "object",
                                "required": [ "sql" ],
                                "properties": { "sql": { "type": "string" } }
                            },
                            {
                                "type": "object",
                                "required": [ "value" ],
                                "properties": { "value": {} }
                            },
                            {
                                "type": "object",
                                "required": [ "expression" ],
                                "properties": { "expression": { "type": "string" } }
                            }
                        ]
                    }
                }
            }
        },
        "actionsBlock": {
            "type": "object",
            "properties": {
                "severity": { "enum": [ "info", "warning", "error", "block" ] },
                "actions": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "pattern": "^(repair|notify|audit|create-task|custom):"
                    }
                }
            }
        }
    }
}
